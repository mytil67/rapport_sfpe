<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats de l'enqu√™te satisfaction - Cr√®ches de Strasbourg (Calcul Am√©lior√©)</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Styles pour la nouvelle configuration de satisfaction */
        .satisfaction-config {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .config-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .method-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .method-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .method-option:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .method-option.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        .method-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .method-label {
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .method-description {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.3;
        }

        .satisfaction-insight {
            background: #e8f4fd;
            border-left: 4px solid #4facfe;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .insight-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .insight-content {
            color: #34495e;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .comparison-badge {
            display: inline-block;
            background: #17a2b8;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 8px;
            font-weight: 500;
        }

        .show-comparison-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .show-comparison-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .improvement-highlight {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .improvement-highlight h4 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
        }

        .improvement-highlight p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.95;
        }

        /* Responsive pour la config de satisfaction */
        @media (max-width: 768px) {
            .satisfaction-config {
                padding: 20px;
            }
            
            .config-header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .method-selector {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .method-option {
                padding: 12px;
            }
            
            .method-icon {
                font-size: 1.5rem;
                margin-bottom: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä R√©sultats de l'enqu√™te satisfaction</h1>
            <p>Cr√®ches de Strasbourg - Analyse automatis√©e avec calcul de satisfaction am√©lior√©</p>
        </div>

        <div class="content">
            <!-- Section d'import de fichier -->
            <div id="file-upload-section" class="file-upload-section">
                <div class="upload-container">
                    <div class="improvement-highlight">
                        <h4>üéØ Nouvelle version avec calcul de satisfaction am√©lior√© !</h4>
                        <p>M√©thodes de calcul plus r√©alistes et moins optimistes pour des r√©sultats plus fiables</p>
                    </div>

                    <h2>üìÅ Importer le fichier de donn√©es</h2>
                    <p>S√©lectionnez le fichier Excel (.xlsx, .xls) contenant les r√©ponses du questionnaire<br>
                    ou un fichier JSON (.json) d'analyse pr√©c√©dente pour un chargement rapide</p>
                    
                    <div class="upload-area" id="upload-area">
                        <div class="upload-icon">üìÅ</div>
                        <p>Glissez-d√©posez votre fichier Excel ou JSON ici ou cliquez pour s√©lectionner</p>
                        <input type="file" id="file-input" accept=".xlsx,.xls,.json" style="display: none;">
                        <button id="select-file-btn" class="upload-btn">S√©lectionner un fichier</button>
                    </div>
                    
                    <div id="file-info" class="file-info" style="display: none;">
                        <p id="file-name"></p>
                        <button id="process-file-btn" class="process-btn">Analyser le fichier</button>
                    </div>

                    <!-- Import JSON rapide -->
                    <div class="json-import-section" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.3);">
                        <h3 style="margin-bottom: 15px;">‚ö° Import rapide JSON</h3>
                        <p style="opacity: 0.9; margin-bottom: 20px; font-size: 0.9rem;">
                            Rechargez instantan√©ment une analyse pr√©c√©dente depuis un fichier JSON export√©
                        </p>
                        
                        <div class="json-upload-area" id="json-upload-area" style="background: rgba(255,255,255,0.15); border: 1px dashed rgba(255,255,255,0.4); border-radius: 10px; padding: 20px; cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-size: 1.5rem; margin-bottom: 10px;">‚ö°</div>
                            <p style="margin: 0; font-size: 0.9rem;">Fichier JSON d'analyse</p>
                            <input type="file" id="json-input" accept=".json" style="display: none;">
                            <div style="margin-top: 10px;">
                                <button id="select-json-btn" class="upload-btn" style="font-size: 0.8rem; padding: 8px 20px;">üì• Charger JSON</button>
                            </div>
                        </div>
                        
                        <div id="json-info" class="file-info" style="display: none; margin-top: 15px;">
                            <p id="json-file-name" style="margin: 0; font-size: 0.9rem;"></p>
                            <p id="json-status" style="margin: 5px 0 0 0; font-size: 0.8rem; opacity: 0.8;"></p>
                        </div>
                    </div>

                    <!-- Section mapping gestionnaires -->
                    <div class="mapping-section" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.3);">
                        <h3 style="margin-bottom: 15px;">üìã Fichier de r√©f√©rence des gestionnaires (optionnel)</h3>
                        <p style="opacity: 0.9; margin-bottom: 20px; font-size: 0.9rem;">
                            Importez votre fichier Excel de correspondance √©tablissement-gestionnaire pour un classement pr√©cis
                        </p>
                        
                        <div class="mapping-upload-area" id="mapping-upload-area" style="background: rgba(255,255,255,0.15); border: 1px dashed rgba(255,255,255,0.4); border-radius: 10px; padding: 20px; cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-size: 1.5rem; margin-bottom: 10px;">üìä</div>
                            <p style="margin: 0; font-size: 0.9rem;">Fichier de mapping √©tablissements</p>
                            <input type="file" id="mapping-input" accept=".xlsx,.xls" style="display: none;">
                            <div style="margin-top: 10px;">
                                <button id="select-mapping-btn" class="upload-btn" style="margin-right: 10px; font-size: 0.8rem; padding: 8px 20px;">S√©lectionner</button>
                                <button id="download-template-btn" class="upload-btn" style="background: rgba(255,255,255,0.7); color: #f5576c; font-size: 0.8rem; padding: 8px 15px;">üì• Template</button>
                            </div>
                        </div>
                        
                        <div id="mapping-info" class="file-info" style="display: none; margin-top: 15px;">
                            <p id="mapping-file-name" style="margin: 0; font-size: 0.9rem;"></p>
                            <p id="mapping-status" style="margin: 5px 0 0 0; font-size: 0.8rem; opacity: 0.8;"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √âtat de chargement -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Traitement des donn√©es avec calcul am√©lior√©...</p>
            </div>

            <!-- Messages d'erreur -->
            <div id="error-message" class="error-message" style="display: none;">
                <h3>‚ùå Erreur lors du traitement</h3>
                <p id="error-text"></p>
                <button id="retry-btn" class="retry-btn">R√©essayer</button>
            </div>

            <!-- R√©sultats -->
            <div id="results" style="display: none;">
                <!-- Vue d'ensemble -->
                <div class="summary">
                    <h2>üìà Vue d'ensemble</h2>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="total-responses">0</span>
                            <span>R√©ponses totales</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="total-etablissements">0</span>
                            <span>√âtablissements</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="satisfaction-globale">0%</span>
                            <span>Satisfaction globale</span>
                            <span class="comparison-badge" id="method-badge">Pond√©r√©</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="date-enquete">-</span>
                            <span>P√©riode d'enqu√™te</span>
                        </div>
                    </div>
                </div>

                <!-- NOUVELLE SECTION : Configuration du calcul de satisfaction -->
                <div class="satisfaction-config" id="satisfaction-config">
                    <div class="config-header">
                        <h3 class="config-title">
                            <span>‚öñÔ∏è</span>
                            <span>M√©thode de calcul de la satisfaction</span>
                        </h3>
                        <button id="show-comparison" class="show-comparison-btn">
                            <span>üìä</span>
                            <span>Voir la comparaison</span>
                        </button>
                    </div>
                    
                    <div class="method-selector" id="method-selector">
                        <div class="method-option active" data-method="weighted">
                            <span class="method-icon">‚öñÔ∏è</span>
                            <div class="method-label">Pond√©r√© (recommand√©)</div>
                            <div class="method-description">Tr√®s satisfait 100%, Plut√¥t satisfait 60%</div>
                        </div>
                        
                        <div class="method-option" data-method="strict">
                            <span class="method-icon">üéØ</span>
                            <div class="method-label">Strict</div>
                            <div class="method-description">Seuls les "Tr√®s satisfait" comptent</div>
                        </div>
                        
                        <div class="method-option" data-method="adjusted">
                            <span class="method-icon">üìä</span>
                            <div class="method-label">Ajust√©</div>
                            <div class="method-description">Tr√®s satisfait 100%, Plut√¥t satisfait 50%</div>
                        </div>
                        
                        <div class="method-option" data-method="trend">
                            <span class="method-icon">üìà</span>
                            <div class="method-label">Tendance globale</div>
                            <div class="method-description">Score bas√© sur tous les niveaux</div>
                        </div>
                    </div>
                </div>

                <!-- NOUVELLE SECTION : Insight sur la satisfaction -->
                <div class="satisfaction-insight" id="satisfaction-insight" style="display: none;">
                    <div class="insight-title">üí° Analyse comparative des m√©thodes</div>
                    <div class="insight-content" id="insight-content">
                        <!-- Le contenu sera g√©n√©r√© dynamiquement -->
                    </div>
                </div>

                <!-- Onglets de vue -->
                <div class="view-tabs">
                    <button class="tab-btn active" data-view="etablissements">üìã Liste alphab√©tique</button>
                    <button class="tab-btn" data-view="satisfaction">üìä Tri par satisfaction</button>
                    <button class="tab-btn" data-view="gestionnaires">üë• Tri par gestionnaires</button>
                    <button class="tab-btn" data-view="repondants">üìà Tri par r√©pondants</button>
					<button class="tab-btn" data-view="global">üåç Statistiques globales</button>
                </div>

                <!-- Conteneur principal pour les tableaux -->
                <div class="table-view-container" id="etablissements-container">
                    <!-- Les tableaux avec contr√¥les seront g√©n√©r√©s ici -->
                </div>

                <!-- Actions globales -->
                <div class="actions">
                    <button id="new-file-btn" class="action-btn">üìÅ Charger un nouveau fichier</button>
                    <button id="export-btn" class="action-btn">üìä Exporter les r√©sultats</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour les d√©tails -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">D√©tails des r√©ponses</h2>
                <button class="close" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modal-loading" class="modal-loading" style="display: none;">
                    <div class="modal-spinner"></div>
                    <p>Chargement des d√©tails...</p>
                </div>
                <div id="modal-content">
                    <!-- Le contenu d√©taill√© sera ins√©r√© ici -->
                </div>
                <div class="modal-actions">
                    <button id="export-pdf-btn" class="modal-action-btn">üìÑ Exporter en PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts externes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    
    <!-- NOUVEAU : Calculateur de satisfaction am√©lior√© -->
    <script>
// SatisfactionCalculator - Version corrig√©e pour une d√©tection plus robuste

class SatisfactionCalculator {
    constructor() {
        this.calculationMethods = {
            strict: {
                name: "Stricte",
                description: "Seuls les 'Tr√®s satisfait' comptent comme satisfaits",
                satisfiedLevels: ['tr√®s satisfait'],
                weight: 1.0
            },
            weighted: {
                name: "Pond√©r√©e",
                description: "Tr√®s satisfait = 100%, Plut√¥t satisfait = 60%",
                satisfiedLevels: ['tr√®s satisfait', 'plut√¥t satisfait'],
                weights: {
                    'tr√®s satisfait': 1.0,
                    'plut√¥t satisfait': 0.6,
                    'peu satisfait': 0.2,
                    'pas satisfait': 0.0
                }
            },
            adjusted: {
                name: "Ajust√©e",
                description: "Tr√®s satisfait = 100%, Plut√¥t satisfait = 50%",
                satisfiedLevels: ['tr√®s satisfait', 'plut√¥t satisfait'],
                weights: {
                    'tr√®s satisfait': 1.0,
                    'plut√¥t satisfait': 0.5,
                    'peu satisfait': 0.0,
                    'pas satisfait': 0.0
                }
            },
            trend: {
                name: "Tendance",
                description: "Score global bas√© sur tous les niveaux",
                satisfiedLevels: ['tr√®s satisfait', 'plut√¥t satisfait', 'peu satisfait', 'pas satisfait'],
                weights: {
                    'tr√®s satisfait': 1.0,
                    'plut√¥t satisfait': 0.67,
                    'peu satisfait': 0.33,
                    'pas satisfait': 0.0
                }
            }
        };
    }

    // M√âTHODE CORRIG√âE : Normalisation plus robuste
    normalizeAccents(str) {
        return str
            .toLowerCase()
            .replace(/[√†√°√¢√£√§√•]/g, 'a')
            .replace(/[√®√©√™√´ƒì]/g, 'e')
            .replace(/[√¨√≠√Æ√Ø]/g, 'i')
            .replace(/[√≤√≥√¥√µ√∂≈ç]/g, 'o')
            .replace(/[√π√∫√ª√º]/g, 'u')
            .replace(/[√ß]/g, 'c')
            .replace(/[√±]/g, 'n')
            .replace(/[^a-z\s]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
    }

    // M√âTHODE CORRIG√âE : Classification plus robuste des niveaux de satisfaction
    classifySatisfactionLevel(originalKey) {
        if (!originalKey || typeof originalKey !== 'string') {
            return null;
        }

        const normalized = this.normalizeAccents(originalKey.toString().trim());
        
        console.log(`üîç Classification: "${originalKey}" ‚Üí "${normalized}"`);

        // TR√àS SATISFAIT (toutes les variantes possibles)
        if (
            normalized.includes('tres satisfait') ||
            normalized.includes('tres satisfaisant') ||
            normalized.includes('tres satisfaisante') ||
            normalized.includes('tres content') ||
            normalized.includes('tres contente') ||
            normalized.includes('totalement satisfait') ||
            normalized.includes('totalement satisfaisant') ||
            normalized.includes('tout a fait satisfait') ||
            normalized.includes('parfaitement satisfait') ||
            (normalized.includes('tres') && (normalized.includes('satisfai') || normalized.includes('content')))
        ) {
            console.log(`‚úÖ ‚Üí TR√àS SATISFAIT`);
            return 'tr√®s satisfait';
        }

        // PLUT√îT SATISFAIT
        if (
            normalized.includes('plutot satisfait') ||
            normalized.includes('plutot satisfaisant') ||
            normalized.includes('plutot satisfaisante') ||
            normalized.includes('plutot content') ||
            normalized.includes('plutot contente') ||
            normalized.includes('assez satisfait') ||
            normalized.includes('relativement satisfait') ||
            (normalized.includes('plutot') && (normalized.includes('satisfai') || normalized.includes('content')))
        ) {
            console.log(`‚úÖ ‚Üí PLUT√îT SATISFAIT`);
            return 'plut√¥t satisfait';
        }

        // PEU SATISFAIT
        if (
            normalized.includes('peu satisfait') ||
            normalized.includes('peu satisfaisant') ||
            normalized.includes('peu satisfaisante') ||
            normalized.includes('peu content') ||
            normalized.includes('peu contente') ||
            normalized.includes('moyennement satisfait') ||
            normalized.includes('pas tres satisfait') ||
            (normalized.includes('peu') && (normalized.includes('satisfai') || normalized.includes('content')))
        ) {
            console.log(`‚úÖ ‚Üí PEU SATISFAIT`);
            return 'peu satisfait';
        }

        // PAS SATISFAIT
        if (
            normalized.includes('pas satisfait') ||
            normalized.includes('pas satisfaisant') ||
            normalized.includes('pas satisfaisante') ||
            normalized.includes('pas content') ||
            normalized.includes('pas contente') ||
            normalized.includes('pas du tout satisfait') ||
            normalized.includes('insatisfait') ||
            normalized.includes('mecontent') ||
            normalized.includes('non satisfait') ||
            (normalized.includes('pas') && (normalized.includes('satisfai') || normalized.includes('content')))
        ) {
            console.log(`‚úÖ ‚Üí PAS SATISFAIT`);
            return 'pas satisfait';
        }

        // NON SP√âCIFI√â / DONN√âES PARASITES
        if (
            normalized.includes('non specifie') ||
            normalized.includes('non precise') ||
            normalized.includes('sans reponse') ||
            normalized.includes('n a') ||
            normalized.includes('vide') ||
            normalized === '' ||
            normalized === 'null' ||
            normalized === 'undefined'
        ) {
            console.log(`‚ùå ‚Üí NON SP√âCIFI√â (ignor√©)`);
            return null; // Sera ignor√© dans le calcul
        }

        console.log(`‚ùì ‚Üí AUTRE/INCONNU (ignor√©)`);
        return null; // Cl√© non reconnue, sera ignor√©e
    }

    // M√âTHODE CORRIG√âE : Analyse des donn√©es avec meilleure classification
    analyzeSatisfactionData(satisfactionData) {
        if (!satisfactionData || typeof satisfactionData !== 'object') {
            console.log('‚ùå Donn√©es invalides');
            return null;
        }

        console.log('üì• === ANALYSE DES DONN√âES ===');
        console.log('Donn√©es brutes:', satisfactionData);

        const cleanData = {
            'tr√®s satisfait': 0,
            'plut√¥t satisfait': 0,
            'peu satisfait': 0,
            'pas satisfait': 0
        };

        let totalValidResponses = 0;
        let totalIgnored = 0;

        Object.entries(satisfactionData).forEach(([key, value]) => {
            if (!key || !value || typeof value !== 'number' || value <= 0) {
                console.log(`‚è≠Ô∏è Ignor√© (valeur invalide): "${key}" = ${value}`);
                return;
            }

            const classifiedLevel = this.classifySatisfactionLevel(key);
            
            if (classifiedLevel) {
                cleanData[classifiedLevel] += value;
                totalValidResponses += value;
                console.log(`‚úÖ Ajout√©: "${key}" (${value}) ‚Üí ${classifiedLevel}`);
            } else {
                totalIgnored += value;
                console.log(`‚ùå Ignor√©: "${key}" (${value}) - non classifiable`);
            }
        });

        console.log('üìä === R√âSULTATS DE L\'ANALYSE ===');
        console.log('Donn√©es nettoy√©es:', cleanData);
        console.log(`R√©ponses valides: ${totalValidResponses}`);
        console.log(`R√©ponses ignor√©es: ${totalIgnored}`);

        return {
            data: cleanData,
            totalResponses: totalValidResponses + totalIgnored,
            validResponses: totalValidResponses,
            ignoredResponses: totalIgnored
        };
    }

    // M√âTHODE PRINCIPALE : Calcul multiple avec analyse corrig√©e
    calculateSatisfactionMultiple(satisfactionData) {
        console.log('üéØ === CALCUL SATISFACTION MULTIPLE CORRIG√â ===');
        
        const analyzed = this.analyzeSatisfactionData(satisfactionData);
        if (!analyzed || analyzed.validResponses === 0) {
            console.log('‚ùå Aucune donn√©e valide √† analyser');
            return null;
        }

        const results = {};
        
        // Calculer avec chaque m√©thode
        Object.entries(this.calculationMethods).forEach(([methodKey, method]) => {
            results[methodKey] = this.calculateWithMethod(analyzed, method);
            console.log(`üìä ${method.name}: ${results[methodKey]}%`);
        });

        // M√©triques d√©taill√©es
        results.metrics = {
            totalResponses: analyzed.totalResponses,
            validResponses: analyzed.validResponses,
            ignoredResponses: analyzed.ignoredResponses,
            distribution: analyzed.data,
            nonResponseRate: analyzed.totalResponses > 0 ? 
                Math.round((analyzed.ignoredResponses / analyzed.totalResponses) * 100) : 0,
            insatisfactionRate: analyzed.validResponses > 0 ? 
                Math.round(((analyzed.data['peu satisfait'] + analyzed.data['pas satisfait']) / analyzed.validResponses) * 100) : 0,
            excellenceRate: analyzed.validResponses > 0 ? 
                Math.round((analyzed.data['tr√®s satisfait'] / analyzed.validResponses) * 100) : 0
        };

        console.log('üéØ === M√âTRIQUES FINALES ===');
        console.log(`Tr√®s satisfait: ${analyzed.data['tr√®s satisfait']} (${results.metrics.excellenceRate}%)`);
        console.log(`Plut√¥t satisfait: ${analyzed.data['plut√¥t satisfait']}`);
        console.log(`Peu satisfait: ${analyzed.data['peu satisfait']}`);
        console.log(`Pas satisfait: ${analyzed.data['pas satisfait']}`);
        console.log(`Taux d'insatisfaction: ${results.metrics.insatisfactionRate}%`);
        console.log('üéØ === FIN CALCUL ===\n');

        return results;
    }

    // Calcul avec une m√©thode sp√©cifique
    calculateWithMethod(analyzed, method) {
        const { data, validResponses } = analyzed;
        
        if (validResponses === 0) return 0;

        if (method.weights) {
            // Calcul pond√©r√©
            let weightedSum = 0;
            let totalResponses = 0;

            Object.entries(method.weights).forEach(([level, weight]) => {
                const count = data[level] || 0;
                weightedSum += count * weight;
                totalResponses += count;
            });

            return totalResponses > 0 ? Math.round((weightedSum / totalResponses) * 100) : 0;
        } else {
            // Calcul simple (stricte)
            const satisfiedCount = method.satisfiedLevels.reduce((sum, level) => {
                return sum + (data[level] || 0);
            }, 0);

            return Math.round((satisfiedCount / validResponses) * 100);
        }
    }

    // TEST UNITAIRE pour votre cas sp√©cifique
    testSingleVeryHappy() {
        console.log('üß™ === TEST UNITAIRE : UNE R√âPONSE TR√àS SATISFAITE ===');
        
        const testData = {
            "Tr√®s satisfaisant": 1  // Votre cas exact
        };

        const result = this.calculateSatisfactionMultiple(testData);
        
        console.log('üìã Donn√©es de test:', testData);
        console.log('üìä R√©sultats:');
        console.log(`  Stricte: ${result.strict}% (devrait √™tre 100%)`);
        console.log(`  Pond√©r√©e: ${result.weighted}% (devrait √™tre 100%)`);
        console.log(`  Ajust√©e: ${result.adjusted}% (devrait √™tre 100%)`);
        console.log(`  Tendance: ${result.trend}% (devrait √™tre 100%)`);
        
        // V√©rification
        if (result.weighted === 100) {
            console.log('‚úÖ TEST R√âUSSI : Le calcul est correct !');
        } else {
            console.log('‚ùå TEST √âCHOU√â : Le calcul doit √™tre corrig√© !');
        }
        
        return result;
    }

    // G√©n√©ration de rapport d√©taill√©
    generateSatisfactionReport(satisfactionData, establishmentName = '') {
        const results = this.calculateSatisfactionMultiple(satisfactionData);
        if (!results) return null;

        return {
            establishment: establishmentName,
            timestamp: new Date().toISOString(),
            satisfaction: {
                recommended: results.weighted,
                alternative: results.adjusted,
                strict: results.strict,
                comprehensive: results.trend
            },
            raw: results.metrics,
            classification: results.metrics.distribution
        };
    }
}

// Test automatique au chargement
if (typeof window !== 'undefined') {
    window.SatisfactionCalculator = SatisfactionCalculator;
    
    // Lancer le test automatiquement
    const testCalc = new SatisfactionCalculator();
    testCalc.testSingleVeryHappy();
    
    console.log('‚úÖ SatisfactionCalculator corrig√© charg√© et test√©');
}
    </script>
    
    <!-- Gestionnaire PDF am√©lior√© -->
    <script src="pdf-formatter.js"></script>
    
    <!-- Application principale -->
    <script src="app.js"></script>
	<script src="global-stats.js"></script>

    <!-- NOUVEAU : Script pour g√©rer la configuration de satisfaction -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Initialisation de l\'interface de satisfaction am√©lior√©e...');
            
            // Initialiser la configuration des m√©thodes
            let currentMethod = 'weighted';
            
            // Fonction globale pour r√©cup√©rer la m√©thode courante
            window.getCurrentSatisfactionMethod = () => currentMethod;
            window.currentSatisfactionMethod = currentMethod;
            
            // G√©rer le changement de m√©thode
            document.querySelectorAll('.method-option').forEach(option => {
                option.addEventListener('click', function() {
                    const method = this.dataset.method;
                    
                    // Mettre √† jour l'interface
                    document.querySelectorAll('.method-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mettre √† jour la m√©thode courante
                    currentMethod = method;
                    window.currentSatisfactionMethod = method;
                    
                    // Mettre √† jour le badge
                    const badge = document.getElementById('method-badge');
                    const methodNames = {
                        'weighted': 'Pond√©r√©',
                        'strict': 'Strict',
                        'adjusted': 'Ajust√©',
                        'trend': 'Tendance'
                    };
                    if (badge) {
                        badge.textContent = methodNames[method];
                    }
                    
                    // Recalculer et mettre √† jour l'affichage si des donn√©es sont disponibles
                    if (window.surveyApp && window.surveyApp.dataAnalyzer && window.surveyApp.dataAnalyzer.getSurveyData) {
                        try {
                            updateSatisfactionDisplay(method);
                        } catch (error) {
                            console.log('Donn√©es non encore disponibles pour la mise √† jour');
                        }
                    }
                    
                    console.log(`üîß M√©thode de calcul chang√©e: ${method}`);
                });
            });
            
            // Afficher/masquer la comparaison
            const showComparisonBtn = document.getElementById('show-comparison');
            if (showComparisonBtn) {
                showComparisonBtn.addEventListener('click', function() {
                    const insight = document.getElementById('satisfaction-insight');
                    if (insight.style.display === 'none' || !insight.style.display) {
                        showSatisfactionComparison();
                        insight.style.display = 'block';
                        this.innerHTML = '<span>üîº</span><span>Masquer la comparaison</span>';
                    } else {
                        insight.style.display = 'none';
                        this.innerHTML = '<span>üìä</span><span>Voir la comparaison</span>';
                    }
                });
            }
            
            function updateSatisfactionDisplay(method) {
                try {
                    const surveyData = window.surveyApp.dataAnalyzer.getSurveyData();
                    const rawData = window.surveyApp.dataAnalyzer.getRawData();
                    
                    // Mettre √† jour l'affichage
                    window.surveyApp.uiRenderer.renderSummary(surveyData, rawData);
                    window.surveyApp.uiRenderer.renderEtablissements(surveyData, window.surveyApp.dataAnalyzer);
                    
                    // Mettre √† jour la comparaison si elle est affich√©e
                    const insight = document.getElementById('satisfaction-insight');
                    if (insight && insight.style.display !== 'none') {
                        showSatisfactionComparison();
                    }
                    
                    console.log(`‚úÖ Affichage mis √† jour avec la m√©thode: ${method}`);
                } catch (error) {
                    console.log('Donn√©es non encore disponibles pour la mise √† jour:', error);
                }
            }
            
            function showSatisfactionComparison() {
                if (!window.surveyApp || !window.surveyApp.dataAnalyzer || !window.surveyApp.dataAnalyzer.getSurveyData) {
                    console.log('Donn√©es non disponibles pour la comparaison');
                    return;
                }
                
                try {
                    const surveyData = window.surveyApp.dataAnalyzer.getSurveyData();
                    const calculator = new SatisfactionCalculator();
                    
                    let comparisonHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">';
                    
                    // Calculer pour chaque √©tablissement et faire une moyenne
                    const allResults = [];
                    Object.entries(surveyData).forEach(([name, data]) => {
                        const results = calculator.calculateSatisfactionMultiple(data.satisfaction);
                        if (results) allResults.push(results);
                    });
                    
                    if (allResults.length > 0) {
                        const avgResults = {
                            strict: Math.round(allResults.reduce((sum, r) => sum + r.strict, 0) / allResults.length),
                            weighted: Math.round(allResults.reduce((sum, r) => sum + r.weighted, 0) / allResults.length),
                            adjusted: Math.round(allResults.reduce((sum, r) => sum + r.adjusted, 0) / allResults.length),
                            trend: Math.round(allResults.reduce((sum, r) => sum + r.trend, 0) / allResults.length)
                        };
                        
                        // Calculer l'√©cart avec l'ancien calcul (simulation)
                        const oldCalculation = Math.round(allResults.reduce((sum, r) => {
                            // Simulation de l'ancien calcul (Tr√®s + Plut√¥t satisfait)
                            const total = r.metrics.validResponses;
                            const satisfied = r.metrics.distribution['tr√®s satisfait'] + r.metrics.distribution['plut√¥t satisfait'];
                            return sum + (total > 0 ? (satisfied / total) * 100 : 0);
                        }, 0) / allResults.length);
                        
                        Object.entries(avgResults).forEach(([method, score]) => {
                            const isActive = method === currentMethod;
                            const difference = score - oldCalculation;
                            const diffText = difference > 0 ? `+${difference}` : `${difference}`;
                            const diffColor = difference > 0 ? '#28a745' : '#dc3545';
                            
                            comparisonHTML += `
                                <div style="background: ${isActive ? '#4facfe' : 'white'}; color: ${isActive ? 'white' : '#333'}; padding: 18px; border-radius: 10px; text-align: center; ${isActive ? 'box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3); transform: translateY(-2px);' : 'border: 2px solid #e9ecef;'}">
                                    <div style="font-size: 1.8rem; font-weight: bold; margin-bottom: 8px;">${score}%</div>
                                    <div style="font-size: 0.95rem; margin-bottom: 6px; opacity: 0.9;">${calculator.calculationMethods[method].name}</div>
                                    <div style="font-size: 0.8rem; color: ${isActive ? 'rgba(255,255,255,0.8)' : diffColor}; font-weight: 500;">
                                        vs ancien: ${diffText} pts
                                    </div>
                                    ${isActive ? '<div style="font-size: 0.75rem; margin-top: 8px; padding: 4px 8px; background: rgba(255,255,255,0.2); border-radius: 12px;">‚úì M√©thode active</div>' : ''}
                                </div>
                            `;
                        });
                        
                        comparisonHTML += '</div>';
                        
                        // Ajouter des informations sur l'am√©lioration
                        const improvement = oldCalculation - avgResults.weighted;
                        comparisonHTML += `
                            <div style="background: linear-gradient(135deg, #e8f4fd 0%, #fff 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #4facfe;">
                                <h4 style="margin: 0 0 12px 0; color: #2c3e50;">üìä Analyse de l'am√©lioration</h4>
                                <div style="font-size: 0.95rem; line-height: 1.6; color: #34495e;">
                                    <p style="margin: 0 0 8px 0;"><strong>Ancien calcul (optimiste) :</strong> ${oldCalculation}%</p>
                                    <p style="margin: 0 0 8px 0;"><strong>Nouveau calcul (r√©aliste) :</strong> ${avgResults.weighted}%</p>
                                    <p style="margin: 0 0 12px 0;"><strong>Diff√©rence :</strong> ${improvement > 0 ? '-' : '+'}${Math.abs(improvement)} points</p>
                                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 0.9rem;">
                                        üí° <strong>Explication :</strong> ${improvement > 0 ? 
                                            `L'ancien calcul √©tait ${improvement} points trop optimiste en comptant les "Plut√¥t satisfait" comme 100% satisfaits. La nouvelle m√©thode pond√©r√©e est plus r√©aliste.` :
                                            'Les deux m√©thodes donnent des r√©sultats similaires pour ce jeu de donn√©es.'
                                        }
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('insight-content').innerHTML = comparisonHTML;
                } catch (error) {
                    console.error('Erreur lors de la g√©n√©ration de la comparaison:', error);
                    document.getElementById('insight-content').innerHTML = `
                        <p style="color: #666; font-style: italic;">
                            La comparaison sera disponible une fois les donn√©es charg√©es.
                        </p>
                    `;
                }
            }
            
            console.log('‚úÖ Interface de satisfaction am√©lior√©e initialis√©e');
        });
    </script>
</body>
</html>